# Xmas Poll 2025
Rails Form Submission using REST API

## gems
gem "httparty"
gem "rails-controller-testing"
gem "dotenv-rails", groups: [:development, :test]

## Database Tables
CREATE TABLE "POLLS" 
(	
  "ID" NUMBER GENERATED BY DEFAULT ON NULL AS IDENTITY MINVALUE 1 MAXVALUE 9999999999999999999999999999 INCREMENT BY 1 START WITH 1 CACHE 20 NOORDER  NOCYCLE  NOKEEP  NOSCALE  NOT NULL ENABLE, 
	"NAME" VARCHAR2(100 CHAR) NOT NULL ENABLE, 
	CONSTRAINT "POLLS_PK" PRIMARY KEY ("ID")
  USING INDEX  ENABLE
);

CREATE TABLE "POLL_QUESTIONS" 
(	
  "NO" NUMBER(2,0) NOT NULL ENABLE, 
	"TITLE" VARCHAR2(100 CHAR), 
	"POLL_ID" NUMBER NOT NULL ENABLE, 
	"ANSWERS" VARCHAR2(200), 
	CONSTRAINT "POLL_QUESTIONS_PK" PRIMARY KEY ("NO", "POLL_ID")
  USING INDEX  ENABLE
);

CREATE TABLE "POLL_RESULTS" 
(	
  "ID" NUMBER GENERATED BY DEFAULT ON NULL AS IDENTITY MINVALUE 1 MAXVALUE 9999999999999999999999999999 INCREMENT BY 1 START WITH 1 CACHE 20 NOORDER  NOCYCLE  NOKEEP  NOSCALE  NOT NULL ENABLE, 
	"POLL_ID" NUMBER NOT NULL ENABLE, 
	"QUESTION_NO" NUMBER NOT NULL ENABLE, 
	"RESULT" VARCHAR2(100 CHAR) NOT NULL ENABLE, 
	 CONSTRAINT "POLL_RESULTS_PK" PRIMARY KEY ("ID")
  USING INDEX  ENABLE
);

## API Endpoints
`GET`: https://oracleapex.com/ords/teochewthunder/polls/poll/:id

SELECT p.NAME, pq.SERIAL_NO, pq.TITLE FROM POLLS p
LEFT JOIN POLL_QUESTIONS pq ON pq.POLL_ID = p.ID
WHERE p.ID = :id
ORDER BY pq.SERIAL_NO

`POST`: https://oracleapex.com/ords/teochewthunder/polls/poll/:id

DECLARE
  l_request_body_clob CLOB;
  l_keys APEX_T_VARCHAR2 := APEX_T_VARCHAR2(); -- Initialize the collection
BEGIN
  -- 1. Use the implicit :body_text bind variable to access the request body
  l_request_body_clob := :body_text;

  -- 2. Parse the JSON payload from the CLOB
  APEX_JSON.parse(p_source => l_request_body_clob);

  -- 3. Get the keys (which are the serial numbers) from the 'answers' object
  l_keys := APEX_JSON.get_members(p_path => 'answers');
  
  -- 4. Check if the collection has elements before iterating
  IF l_keys IS NOT NULL AND l_keys.COUNT > 0 THEN
    -- 5. Process each key-value pair in the object
    FOR i IN 1..l_keys.COUNT LOOP
      DECLARE
        l_serial_no VARCHAR2(255);
        l_answer_value VARCHAR2(4000);
      BEGIN
        l_serial_no := l_keys(i);
        l_answer_value := APEX_JSON.get_varchar2(p_path => 'answers.' || l_serial_no);

        INSERT INTO POLL_RESULTS (POLL_ID, QUESTION_SERIAL_NO, RESULT)
        VALUES (:id, TO_NUMBER(l_serial_no), l_answer_value);
      END;
    END LOOP;
  END IF;

  -- 6. Send a success response
  APEX_JSON.open_object;
  APEX_JSON.write('status', 'success');
  APEX_JSON.write('message', 'Answers processed successfully');
  APEX_JSON.close_object;

EXCEPTION
  WHEN OTHERS THEN
    APEX_JSON.open_object;
    APEX_JSON.write('status', 'error');
    APEX_JSON.write('message', 'PL/SQL Error: ' || SQLERRM);
    APEX_JSON.close_object;
END;


`GET`: https://oracleapex.com/ords/teochewthunder/polls/poll/:id/results/

SELECT pq.TITLE, AVG(TO_NUMBER(pr.RESULT)) AS AVG_RESULT, MEDIAN(TO_NUMBER(pr.RESULT)) AS MEDIAN_RESULT FROM POLL_QUESTIONS pq
LEFT JOIN POLL_RESULTS pr ON pr.QUESTION_SERIAL_NO = pq.SERIAL_NO AND pr.POLL_ID = :id AND pq.POLL_ID = :id
GROUP BY pq.TITLE
ORDER BY AVG_RESULT DESC, MEDIAN_RESULT DESC
